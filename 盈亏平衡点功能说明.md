# 盈亏平衡点辅助线功能说明

## 功能概述
在价格曲线对比图中添加盈亏平衡点辅助线，显示新价格和企业价格的交点位置。

## 功能详情

### 1. 盈亏平衡点计算
- **计算逻辑**：寻找新价格曲线和企业价格曲线的交点
- **算法**：使用线性插值精确计算两条曲线的交点坐标
- **数学原理**：
  - 找到两条曲线符号变化的位置（从 new > qy 变为 new < qy，或反之）
  - 在该区间使用线性插值求解精确交点

```python
# 核心算法
diff = new_curve - qy_curve
sign_changes = np.where(np.diff(np.sign(diff)))[0]

# 线性插值求交点
t = (y1_qy - y1_new) / ((y2_new - y1_new) - (y2_qy - y1_qy))
break_even_weight = x1 + t * (x2 - x1)
break_even_price = y1_new + t * (y2_new - y1_new)
```

### 2. 可视化元素

#### 红色垂直虚线
- **样式**：红色虚线，线宽2像素
- **位置**：精确位于交点的重量坐标
- **作用**：醒目标识盈亏平衡的重量点

#### 红色星形标记
- **样式**：红色五角星，大小12，带深红色边框
- **位置**：精确位于交点坐标 (重量, 价格)
- **交互**：鼠标悬停显示详细信息

#### 文字标注
- **内容**：显示盈亏平衡点的重量和价格
- **格式**：
  ```
  盈亏平衡点
  X.XX kg
  X.XX 元
  ```
- **位置**：垂直线顶部
- **字体**：11号，红色，微软雅黑

### 3. 使用场景

#### 场景1：新价格低于企业价格
```
当利润率较低时，新价格曲线可能在某个重量点之前低于企业价格
→ 表示在该重量之前，使用新价格更便宜
→ 平衡点后，企业价格更有竞争力
```

#### 场景2：新价格高于企业价格
```
当利润率较高时，新价格曲线可能在某个重量点之后高于企业价格
→ 表示在该重量之前，企业价格更便宜
→ 平衡点后，新价格失去竞争力
```

#### 场景3：无交点
```
如果新价格始终高于或低于企业价格，则不显示平衡点
→ 表示在整个重量范围内，一方始终占优
```

### 4. 业务价值

#### 定价决策
- 快速识别不同重量段的竞争力
- 帮助确定最优利润率设置
- 评估价格策略的市场竞争力

#### 客户分析
- 识别哪些重量段的客户更适合新价格
- 哪些重量段应该推荐企业价格
- 优化客户分层策略

#### 风险控制
- 识别价格倒挂的风险区间
- 评估不同利润率下的盈亏状况
- 制定差异化定价策略

### 5. 交互功能

#### 鼠标悬停
- **曲线悬停**：显示该点的重量和价格
- **平衡点悬停**：显示平衡点的精确坐标
- **信息格式**：
  ```
  盈亏平衡点
  重量: 8.23 kg
  价格: 45.67 元
  ```

#### 图例控制
- 可点击图例隐藏/显示盈亏平衡点标记
- 可隐藏任意曲线，便于对比分析

### 6. 技术实现

#### 添加的代码模块

**模块1：交点计算**（约25行）
```python
# 位置：第124-143行
break_even_weight = None
break_even_price = None
if not np.any(np.isnan(new_curve)) and not np.any(np.isnan(qy_curve)):
    diff = new_curve - qy_curve
    sign_changes = np.where(np.diff(np.sign(diff)))[0]
    if len(sign_changes) > 0:
        # 线性插值计算交点
        ...
```

**模块2：可视化元素**（约18行）
```python
# 位置：第189-206行
if break_even_weight is not None:
    # 垂直虚线
    fig.add_vline(...)
    
    # 星形标记
    fig.add_trace(go.Scatter(...))
```

#### 依赖的库
- `numpy`：数组运算和符号检测
- `plotly.graph_objects`：垂直线和标记绘制
- 无额外依赖

### 7. 示例效果

#### 示例数据
```
利润率：5%
分区：东北
目的地：辽宁
日均区间：1-50票

顺丰价格（5kg）：30.00 元
企业价格（5kg）：28.00 元
新价格（5kg）：31.50 元

盈亏平衡点：7.35 kg, 41.20 元
```

#### 解读
- 在 7.35kg 之前，新价格高于企业价格（亏损区）
- 在 7.35kg 之后，新价格低于企业价格（盈利区）
- 建议：重点推广 7.35kg 以上的货物

### 8. 注意事项

#### 数据有效性
- 如果新价格或企业价格数据缺失，不显示平衡点
- 如果两条曲线没有交点（始终平行），不显示平衡点

#### 计算精度
- 使用 0.5kg 步长进行插值
- 交点计算精度约 ±0.01kg
- 价格精度保留2位小数

#### 多交点情况
- 当前实现仅显示第一个交点
- 如果存在多个交点，只标注第一个
- 可通过调整利润率观察不同的平衡点

## 运行效果

启动应用后：
```bash
streamlit run streamlit_from_csv.py
```

效果展示：
1. ✅ 图表中显示红色垂直虚线
2. ✅ 交点位置有红色五角星标记
3. ✅ 虚线顶部显示重量和价格数值
4. ✅ 鼠标悬停显示详细信息
5. ✅ 图例中可控制显示/隐藏

## 更新日期
2025-11-04

## 功能状态
✅ 已完成并测试
