# 盈亏平衡点汇总功能说明

## 功能概述

在价格分析应用中新增"盈亏平衡点汇总分析"功能，自动计算所有区域、所有目的地、所有日均区间的盈亏平衡点，生成一张全局汇总表格。

## 功能位置

- 位于页面底部，曲线图表和数据表格之后
- 独立的分析模块，用分隔线与上方内容区分

## 表格结构

### 列结构
| 分区 | 目的地 | 日均30-50单 | 日均50-100单 | 日均100-200单 | 日均200-300单 | 日均300-500单 | 日均500单以上 |
|------|--------|-------------|--------------|---------------|---------------|---------------|---------------|
| 一区 | 辽宁   | 5.23kg      | 全盈         | 8.45kg        | 全亏          | 12.30kg       | 数据缺失      |

### 单元格值含义

#### 1. 具体重量值（如 `5.23kg`）
- **含义**：盈亏平衡点在该重量
- **解读**：
  - 重量 > 5.23kg：新价格 < 企业价格，**有竞争力**（盈利）
  - 重量 < 5.23kg：新价格 > 企业价格，**无竞争力**（亏损）
- **业务建议**：重点推广该重量以上的货物

#### 2. 全盈
- **含义**：在整个重量范围（2-15kg）内，新价格始终低于企业价格
- **解读**：任何重量都有竞争力，全面优势
- **业务建议**：该区域该日均区间可积极推广所有重量段

#### 3. 全亏
- **含义**：在整个重量范围（2-15kg）内，新价格始终高于企业价格
- **解读**：任何重量都没有竞争力
- **业务建议**：
  - 考虑降低利润率
  - 暂时不推广该区域该日均区间
  - 评估是否需要特殊定价策略

#### 4. 数据缺失
- **含义**：该区域该日均区间没有完整的价格数据
- **解决方案**：补充CSV中的相关数据

#### 5. 无交点
- **含义**：理论上不应出现，表示曲线异常
- **解决方案**：检查数据是否正确

## 计算逻辑

### 算法流程

```python
1. 遍历所有分区
2. 遍历每个分区的所有目的地
3. 遍历所有日均区间
4. 对每个组合：
   a. 读取顺丰价格和企业价格数据
   b. 计算新价格 = 顺丰价格 × (1 + 利润率)
   c. 分析2-15kg范围内的价格关系
   d. 判断：
      - 如果新价格始终 ≤ 企业价格 → "全盈"
      - 如果新价格始终 ≥ 企业价格 → "全亏"
      - 如果存在交点 → 计算精确重量值
      - 如果数据不全 → "数据缺失"
```

### 分析范围

- **重量范围**：2-15kg（可在代码中调整）
- **计算步长**：0.5kg
- **插值方法**：线性插值
- **精度**：平衡点重量精确到小数点后2位

## 使用场景

### 场景1：全局定价策略评估

**目标**：在设定利润率后，快速评估所有区域的竞争力

**操作步骤**：
1. 设置目标利润率（如 20%）
2. 查看汇总表格
3. 统计"全盈"、"全亏"、有平衡点的数量
4. 评估该利润率是否合理

**示例分析**：
```
利润率 20% 的结果：
- 全盈：15个区域组合（占30%）
- 全亏：10个区域组合（占20%）
- 有平衡点：25个区域组合（占50%）

结论：利润率适中，建议：
- 全盈区域可尝试提高利润率
- 全亏区域需降低利润率或调整策略
```

### 场景2：区域差异化定价

**目标**：识别需要特殊定价策略的区域

**操作步骤**：
1. 查看汇总表格
2. 筛选"全亏"的区域
3. 为这些区域制定差异化利润率

**示例**：
```
一区-辽宁：
- 日均30-50单：全亏
- 日均50-100单：8.5kg
- 日均100-200单：全盈

策略：
- 30-50单：降低利润率至10%重新测试
- 50-100单：推广8.5kg以上货物
- 100-200单：保持当前利润率
```

### 场景3：客户分层与推广

**目标**：根据客户的发货重量和频率，制定推广策略

**操作步骤**：
1. 查看目标区域的平衡点
2. 根据客户发货特征匹配
3. 制定针对性推广话术

**示例**：
```
客户信息：
- 区域：一区-辽宁
- 日均区间：50-100单
- 平均货重：10kg
- 平衡点：8.5kg

推广策略：
✅ 该客户适合推广（10kg > 8.5kg）
话术："您的货物平均重量10kg，使用我们的新价格
      比企业价格每单节省约X元，每天100单可节省XXX元"
```

### 场景4：利润率敏感度分析

**目标**：测试不同利润率对盈亏状况的影响

**操作步骤**：
1. 测试利润率 10%，查看汇总
2. 测试利润率 20%，查看汇总
3. 测试利润率 30%，查看汇总
4. 对比"全盈"和"全亏"的数量变化

**示例结果**：
```
利润率 10%：全盈 40%，全亏 10%
利润率 20%：全盈 30%，全亏 20%
利润率 30%：全盈 15%，全亏 45%

结论：利润率每提高10%，全盈区域减少约10%
     建议利润率设置在 15-20% 之间
```

## 导出功能

### 导出按钮
- 位置：汇总表格下方
- 文件名格式：`盈亏平衡点汇总_利润率20%.csv`
- 编码：UTF-8-sig（支持Excel直接打开）

### 导出内容
- 完整的汇总表格
- 所有分区、目的地、日均区间的数据
- 可在Excel中进一步分析和筛选

### 后续分析建议
在Excel中可以：
1. 使用筛选功能找出所有"全亏"区域
2. 使用条件格式高亮显示平衡点
3. 创建数据透视表进行多维分析
4. 绘制图表展示不同区域的竞争力分布

## 技术细节

### 性能优化
- 使用向量化计算（numpy）提高速度
- 避免重复读取数据
- 批量处理所有区域组合

### 错误处理
- 数据缺失：返回"数据缺失"标记
- 价格异常：捕获异常并标记
- 空值处理：使用 dropna() 预过滤

### 代码结构
```python
def calculate_break_even_point(sf_data, qy_data, profit_rate, weight_range):
    """
    核心计算函数
    输入：顺丰数据、企业数据、利润率、重量范围
    输出：(平衡点重量, 状态标记)
    """
    # 1. 数据验证
    # 2. 曲线构建
    # 3. 差值计算
    # 4. 状态判断（全盈/全亏/平衡点）
    # 5. 交点插值计算
```

## 更新日志

**2025-11-04**
- ✅ 新增盈亏平衡点汇总功能
- ✅ 支持全盈/全亏判断
- ✅ 支持CSV导出
- ✅ 添加详细说明文档

## 使用建议

### 最佳实践

1. **定期更新**：每次价格调整后重新生成汇总表
2. **对比分析**：不同利润率下的汇总表对比
3. **重点关注**：
   - 全亏区域：需要策略调整
   - 平衡点接近15kg：高重货物有优势
   - 平衡点接近2kg：轻货物有优势

4. **团队协作**：
   - 导出汇总表分享给销售团队
   - 标记重点推广区域
   - 制定差异化策略

### 注意事项

1. **数据完整性**：确保CSV包含所有区域的完整数据
2. **利润率设置**：不同区域可能需要不同利润率
3. **动态调整**：根据市场情况定期调整和分析
4. **验证结果**：对异常结果进行人工复核

## 示例输出

```
盈亏平衡点汇总分析
当前利润率：20.0% | 分析重量范围：2-15kg

分区 | 目的地 | 日均30-50单 | 日均50-100单 | 日均100-200单 | ...
-----|--------|-------------|--------------|---------------|----
一区 | 辽宁   | 5.23kg      | 8.45kg       | 全盈          | ...
一区 | 吉林   | 全亏        | 12.30kg      | 全盈          | ...
二区 | 河南   | 6.78kg      | 7.89kg       | 9.45kg        | ...
...  | ...    | ...         | ...          | ...           | ...

说明：
- 具体重量值：表示在该重量点新价格与企业价格持平
- 全盈：整个重量范围内都有竞争力
- 全亏：整个重量范围内都无竞争力
- 数据缺失：该组合没有完整数据

[下载盈亏平衡点汇总表] 按钮
```

## 后续扩展建议

1. **可视化增强**：
   - 添加热力图显示各区域盈亏状况
   - 平衡点分布直方图
   - 竞争力评分

2. **高级分析**：
   - 多利润率对比表
   - 最优利润率推荐
   - ROI计算

3. **交互功能**：
   - 表格内筛选
   - 点击某行跳转到详细曲线图
   - 多选区域对比
