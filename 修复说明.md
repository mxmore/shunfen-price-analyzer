# CSV解析错误修复总结

## 修复时间
2025-11-04

## 问题描述

运行 `streamlit_from_csv.py` 时出现以下两个错误：

### 1. FutureWarning (已弃用警告)
```
FutureWarning: DataFrame.fillna with 'method' is deprecated and will raise in a future version. 
Use obj.ffill() or obj.bfill() instead.
```
- **原因**: pandas 2.x版本中，`fillna(method="ffill")` 已被弃用
- **位置**: 第14行

### 2. ParserError (CSV解析错误)
```
ParserError: Error tokenizing data. C error: Expected 39 fields in line 4, saw 41
```
- **原因**: CSV文件中"目的地"列包含逗号分隔的城市名，导致字段数不匹配
- **影响**: 大部分数据行的字段数都超过39个（标准列数）

## 修复方案

### 修复1: 更新pandas API
**位置**: `read_price_csv()` 函数中的 `_flatten_cols()` 子函数

**原代码**:
```python
cols_df = cols_df.fillna(method="ffill", axis=1)
```

**修复后**:
```python
cols_df = cols_df.ffill(axis=1)
```

### 修复2: 重写CSV读取逻辑
**位置**: `read_price_csv()` 函数

**原问题**:
- CSV文件的"目的地"列包含多个逗号分隔的城市名
- 例如: "上海，北京，天津，安徽，山东，..."
- pandas的标准CSV解析器将这些逗号误认为字段分隔符

**修复方案**:
1. 手动读取文件内容（使用 `utf-8-sig` 编码自动处理BOM）
2. 解析表头确定期望列数（39列）
3. 逐行处理数据:
   - 如果字段数正确（39个），直接使用
   - 如果字段数过多，合并"目的地"列中的多余字段
   - 如果字段数过少，填充空值
4. 构建DataFrame

**核心代码**:
```python
def read_price_csv(csv_path: str) -> pd.DataFrame:
    # 读取文件内容（自动处理BOM）
    with open(csv_path, "r", encoding="utf-8-sig") as f:
        lines = f.readlines()
    
    # 解析表头
    header = lines[0].strip().split(',')
    expected_cols = len(header)
    
    # 解析数据行，合并目的地列中的多余字段
    data_rows = []
    for line in lines[1:]:
        line = line.strip()
        if not line:
            continue
        fields = line.split(',')
        if len(fields) == expected_cols:
            data_rows.append(fields)
        elif len(fields) > expected_cols:
            # 合并目的地列
            extra_fields = len(fields) - expected_cols
            merged_row = [
                fields[0],  # 分区
                ','.join(fields[1:2+extra_fields]),  # 合并目的地
            ] + fields[2+extra_fields:]  # 剩余列
            data_rows.append(merged_row)
        else:
            # 填充空值
            data_rows.append(fields + [''] * (expected_cols - len(fields)))
    
    # 创建DataFrame
    df = pd.DataFrame(data_rows, columns=header)
    df.columns = [str(c).strip() for c in df.columns]
    return df
```

## 测试结果

✅ **所有测试通过**

- 成功读取CSV文件
- 数据形状: (10行, 39列)
- 所有5个分区数据完整（每个分区2行：顺丰价格 + 企业价格）
- 目的地列正确合并多个城市名

**测试输出示例**:
```
各分区的数据行数:
一区    2
二区    2
三区    2
四区    2
五区    2

目的地列样例:
1. 河南（同省）
2. 上海，北京，天津，安徽，山东，山西，广东，江苏，江西，河北，浙江，湖北,陕西,
3. 辽宁，福建,甘肃,广西,贵州,宁夏,四川,重庆，湖南
4. 黑龙江,吉林,内蒙古,青海,云南，海南
5. 新疆,西藏
```

## 后续建议

### 选项1: 修复CSV文件（推荐）
如果可能，建议修复源CSV文件，将包含逗号的字段用引号括起来：
```csv
分区,"目的地",价格对比,...
二区,"上海，北京，天津，安徽，山东，山西，广东，江苏，江西，河北，浙江，湖北，陕西",顺丰价格,...
```

### 选项2: 保持当前修复
当前修复方案已经能够正确处理CSV文件，可以继续使用。

## 文件清单

- **主文件**: `streamlit_from_csv.py` (已修复)
- **数据文件**: `price_table.csv` (保持不变)
- **测试文件**: `test_final.py` (可删除)
- **临时文件**: `test_fix.py`, `test_fix2.py` (可删除)

## 运行方法

现在可以正常运行Streamlit应用：
```powershell
streamlit run streamlit_from_csv.py
```

不会再出现FutureWarning和ParserError错误。
