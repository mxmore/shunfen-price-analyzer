# 顺丰价格分析工具 (Shunfen Price Analyzer)

一个基于Streamlit的交互式价格分析工具，用于对比顺丰价格、企业价格，并计算新价格的盈亏平衡点。

## 功能特性

### 📊 交互式价格曲线对比
- 同一坐标系显示三条价格曲线：顺丰价格、企业价格、新价格
- 基于Plotly的交互式图表，支持缩放、平移、悬停显示详细数值
- 自动线性插值（1-15kg，步长0.5kg）
- 中文字体支持，显示清晰

### ⭐ 盈亏平衡点分析
- **单点分析**：当前选中区域的平衡点可视化
  - 红色虚线标识平衡点位置
  - 红色五角星标记交点
  - 带箭头的文字标注显示精确重量和价格
  
- **全局汇总**：所有区域的盈亏平衡点汇总表
  - 自动计算所有分区、目的地、日均区间的平衡点
  - 智能标识："全盈"（全范围有竞争力）、"全亏"（全范围无竞争力）、具体重量值
  - 支持CSV导出，便于进一步分析

### 📋 数据表格
- 左侧：交互式价格曲线图表
- 右侧：完整数据表格，显示所有插值点的价格
- 支持下载当前曲线数据（CSV格式）

### 🎯 灵活配置
- 分区选择（按一区、二区、三区...自然排序）
- 目的地选择（按字母排序）
- 日均区间选择（6个档位：30-50单、50-100单...）
- 利润率调节（0-200%，步长1%）

## 安装依赖

```bash
pip install streamlit pandas numpy plotly
```

或使用requirements.txt：

```bash
pip install -r requirements.txt
```

## 使用方法

### 1. 准备数据文件

将价格数据导出为CSV文件，命名为 `price_table.csv`，放在与脚本相同的目录下。

**CSV格式要求：**
- 必须包含列：`分区`, `目的地`, `价格对比`
- 价格数据列：6个重量点（1kg, 2kg, 3kg, 4kg, 5kg, 15kg）
- 每个日均区间对应一组重量列，格式如：`日均30-50单_1kg`, `日均30-50单_2kg`...

**示例CSV结构：**
```csv
分区,目的地,价格对比,日均30-50单_1kg,日均30-50单_2kg,...
一区,辽宁,顺丰价格,7.0,10.0,...
一区,辽宁,企业价格,6.5,9.5,...
```

### 2. 运行应用

```bash
streamlit run streamlit_from_csv.py
```

应用将自动在浏览器中打开（默认地址：http://localhost:8501）

### 3. 使用界面

1. **选择分析参数**
   - 选择分区（如：一区）
   - 选择目的地（如：辽宁）
   - 选择日均区间（如：日均30-50单）
   - 设置利润率（如：20%）

2. **查看价格曲线**
   - 左侧图表显示三条曲线对比
   - 鼠标悬停可查看具体数值
   - 如有盈亏平衡点，会显示红色辅助线和标注

3. **分析数据表格**
   - 右侧表格显示所有插值点数据
   - 可下载当前曲线CSV

4. **查看全局汇总**
   - 页面底部显示所有区域的盈亏平衡点汇总
   - 可下载汇总表CSV用于进一步分析

## 业务场景

### 定价策略制定
通过调整利润率，观察不同区域的盈亏状况，制定合理的定价策略。

### 客户推广决策
根据客户的发货重量和目标区域，快速判断是否适合推广新价格。

### 区域差异化定价
识别"全亏"区域，为其制定特殊利润率或营销策略。

### 竞争力分析
对比新价格与企业价格，评估市场竞争力。

## 盈亏平衡点说明

### 单元格值含义

| 显示值 | 含义 | 业务建议 |
|--------|------|----------|
| **5.23kg** | 平衡点在该重量 | 推广该重量以上货物 |
| **全盈** | 全范围有竞争力 | 积极推广所有重量段 |
| **全亏** | 全范围无竞争力 | 考虑降低利润率 |
| **数据缺失** | 价格数据不全 | 需补充数据 |

### 计算逻辑

- **分析范围**：2-15kg（核心业务区间）
- **判断标准**：
  - 新价格始终 ≤ 企业价格 → 全盈
  - 新价格始终 ≥ 企业价格 → 全亏
  - 存在交点 → 显示具体重量值（线性插值精确计算）

## 项目结构

```
newpricecheck2/
├── streamlit_from_csv.py          # 主应用程序
├── price_table.csv                # 价格数据（用户提供）
├── requirements.txt               # Python依赖
├── README.md                      # 项目说明
├── .gitignore                     # Git忽略文件
└── 文档/
    ├── 修复说明.md                # CSV解析修复说明
    ├── 界面优化说明.md            # UI优化说明
    ├── 交互式图表更新说明.md      # Plotly图表说明
    ├── Plotly错误修复说明.md      # API错误修复
    ├── 盈亏平衡点功能说明.md      # 平衡点功能详解
    └── 盈亏平衡点汇总功能说明.md  # 汇总功能详解
```

## 技术栈

- **Streamlit**: Web应用框架
- **Pandas**: 数据处理和分析
- **NumPy**: 数值计算和插值
- **Plotly**: 交互式图表可视化

## 核心功能

### 1. CSV解析
- 自动处理UTF-8-BOM编码
- 智能合并包含逗号的目的地列
- 灵活处理不同格式的CSV文件

### 2. 数据转换
- 宽格式到长格式自动转换
- 多重量点的线性插值
- 自动过滤和清理缺失数据

### 3. 价格计算
- 新价格 = 顺丰价格 × (1 + 利润率%)
- 线性插值生成连续曲线
- 精确计算盈亏平衡点（误差 < 0.01kg）

### 4. 可视化
- Plotly交互式图表
- 自适应布局（宽屏模式）
- 中文字体支持（Microsoft YaHei, SimHei）

## 更新日志

### 2025-11-04
- ✅ 新增盈亏平衡点汇总功能
- ✅ 添加分区自然排序（一区、二区...）
- ✅ 优化平衡点标注位置
- ✅ 修复Plotly API错误
- ✅ 完善项目文档

### 初始版本
- ✅ 基础价格曲线对比功能
- ✅ 交互式Plotly图表
- ✅ CSV数据导入
- ✅ 单点盈亏平衡点显示

## 常见问题

### Q: CSV文件格式不正确怎么办？
A: 确保CSV包含必需的列（分区、目的地、价格对比）和6个重量点的数据列。使用UTF-8编码保存。

### Q: 为什么有些区域显示"数据缺失"？
A: 表示该区域在CSV中没有完整的顺丰价格或企业价格数据，需要补充。

### Q: 如何调整分析的重量范围？
A: 在代码中找到 `calculate_break_even_point` 函数，修改 `(2.0, 15.0)` 参数。

### Q: 可以同时对比多个利润率吗？
A: 当前版本不支持。建议导出不同利润率的汇总表，在Excel中对比分析。

## 贡献

欢迎提交Issue和Pull Request！

## 许可证

MIT License

## 联系方式

- GitHub: [@mxmore](https://github.com/mxmore)
- 项目地址: https://github.com/mxmore/shunfen-price-analyzer

---

**Made with ❤️ using Streamlit**
